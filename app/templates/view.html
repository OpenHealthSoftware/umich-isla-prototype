{% extends "base.html" %}
{% block css %}
<link rel="stylesheet" href="{{url_for('static', filename='css/carousel.css')}}"/>
<link rel="stylesheet" href="{{url_for('static', filename='css/split.css')}}"/>
<link rel="stylesheet" href="{{url_for('static', filename='css/index.css')}}"/>
{% endblock %}
{% block headnav %}{% endblock %}
{% block content %}
	
	

	
	
	<div id="wrapMenuBar"></div><!-- END #wrapMenuBar -->

	<div id="wrapMainScreen">
		<div id="leftScreen" class="split split-horizontal" >
			<div id="fullView">
				{% if not img['imgId'] %}
						<button onclick="router('patient')" class="patient-shade-1 btn-large">Click to Grade an Existing Image</button>
						<button onclick="router('upload')" class="btn-large">Click to Upload a New Control or Patient Image</button>
				{%  else %}

				{% set faSrc = url_for('static', filename='images/uploads/' + img['imgId'] + '.' + img['format']) %}
				{% set gridSrc = url_for('static', filename='images/uploads/grid_' + img['imgId'] + '.' + img['format']) %}
				<div style="position:relative;">
					<img  id="mainFA_image" class="pic" src="{{faSrc}}">
					<img src="{{gridSrc}}" id="grid" class="pic overlay grid" usemap="#map" style="display:block">
					<canvas id="mainFA_canvas" class="traceCanvas" width="0" height="0"></canvas>
				</div>
				<div id="mainNormal">
					<img id="normalImg" class="pic" src="">
					<img id="normalGrid" class="pic overlay grid" src="" >
					<canvas id="norm_canvas" class="traceCanvas" width="0" height="0"></canvas>					
				</div>
				{% endif %}
			</div>
		</div>

		{% if not img['imgId'] %}
		{% set lock = 'lock' %}
		{% endif %}
		<div id="rightScreen" class="split split-horizontal {{lock}}" >
			<div id="menuBar">
				<button id="toggleGridsBtn" class="menu-btn" onclick="toggleGrids()">Hide Grids</button>		
				<button id="toggleUngradedCellBtn" class="menu-btn" onclick="highlightUngradedCells()">Ungraded Cells</button>		
				<div id="menuCont">
					<button id="menuBtn" class="menu-btn">Menu</button>
					<div id="menuDropdownCont">
						<div id="menuDropdown">
							<button onclick="router('patient')" class="patient-shade-1">Patients</button>
							<button onclick="router('normal')" class="normal-shade-1">Normals</button>
							<button onclick="router('upload')">Upload</button>
							<button onclick="router('his')">Help / Info</button>
						</div>
					</div>
				</div>	<!-- END #menuCont -->
			</div> <!-- END #menuBar -->
			
			<div id="wrapCellControl">
				
				<div id="cellPreview">
					
				</div>
				<div id="cellTools">
					
				</div>
				<div id="libraryPreview" class="hidden"></div>

			</div><!-- END #wrapCellControl -->

			<div id="wrapGradeOptions">
				<div id="primaryGrade" class="firstClassOptions">
					
				</div>

				<div id="secondaryGrades">
					<div id="wrapAssociatedOptions" class="secondClassOptions">
						<div></div>
					</div>
					<div id="definitionsToolbar">
						
					</div>
				</div> <!-- END #secondaryGrades -->

			</div><!--END #wrapGradeOptions -->

			<div id="wrapGradeSubmit"></div>

			<div id="gradeView">
				<div id="cells" class="">

					<div class="cellRow" id="gradeButtons"> <!-- Grading buttons -->
						<div class="cellContainer">
							<form id="gradeForm" class="submit-input-container">
								<input type="radio" name="grade" value="perfused" id="gradePerf"><label for="gradePerf">Perfused</label><br>
								<input type="radio" name="grade" value="non-perfused" id="gradeNonPerf"><label for="gradeNonPerf">Non-Perfused</label><br>
								<input type="radio" name="grade" value="blockage" id="gradeBlock"><label for="gradeBlock">Blockage</label><br>
							</form>
							<div id="contrastSettings" class="">
								<p>Contrast: <span id="contrastOutputPercent">100</span>%</p>
								<div id="contrastSlider" class=""></div><div id="cSlidFix"></div>
							</div>
						</div>
				
						<div id="gradingButtons" class="cellContainer">
							<div id="autoSaveNotif" class=""></div>
							<button id="nextNormalBtn" class="normal-shade-1" onclick="cycleNormal(1)">Cycle Normal</button>
							<button id="nextCell" onclick="nextCell()">Next Cell</button>
						</div>
					</div>

					<div class="cellRow">
						<div class="cellContainer">
							<p class="cellLabel">Selected Cell</p>
						</div>
					</div>

					<div class="cellRow"><!-- Selected cells -->
						<div id="gradeCell" class="cellContainer" style="width: auto">
							<canvas id="cellViewCanvas" class="cellCanvas" width="0" height="0"></canvas>
						</div>

						<div id="normalCell" class="cellContainer">			
							<canvas id="normalCellViewCanvas" class="cellCanvas" width="0" height="0"></canvas>
						</div>
					</div><!-- END .cellRow -->

					<div class="cellRow"> <!-- Flipped/mirrored cells -->
						<div class="cellContainer" style="width: auto">
							<canvas id="mainCellFlippedCanvas" class="cellCanvas" width="0" height="0"></canvas>						
						</div>
						<div class="cellContainer">
							<canvas id="normalCellFlippedCanvas" class="cellCanvas" width="0" height="0"></canvas>
						</div>
					</div> <!-- END .cellRow -->					
				</div> <!-- END #cells -->

				
				
				<div style="clear:both;"></div>
				
				<div id="associatedFeatures" class="submit-input-container">
					{% for a in associatedFeatures %}
					<div class="option-box-element">
						<input class="optional-input" type="checkbox" id="option_{{a.optionId}}" name="associatedFeature" value="{{a.name}}">
						<label for="option_{{a.optionId}}">{{a.name}}</label>
					</div>
					{% endfor %}
				</div>
				
				
			</div> <!-- END #gradeView -->

			
			
		</div><!-- END #rightScreen -->

		<div id="wrapSideBar"></div><!-- END #wrapSideBar -->
	</div><!-- END #wrapMainScreen -->

	<div id="wrapStatusBar"></div><!-- END #wrapStatusBar -->
	
	<div id="viewFrameCont" class="popup">
		<div id="exitFrame" class="exitFrame"><button>Close</button></div>
		<div id="viewFrame" class="viewFrame"></div>
	</div>

	<div id="continueFrameCont" class="popup">
		<div id="exitContinueFrame" class="exitFrame"><button>Close</button></div>
		<div id="viewContinueFrame" class="viewFrame">
			<br/><br/>
			You have graded all of the cells. Choose an option to continue.<br/>
			<button id="export">Export grade to file</button>
			<button onclick="router('patient')" class="patient-shade-1">Grade another image</button>
		</div>
	</div>

	{% if gradeSessions %}
	<div id="form-popup" class="popup">
		<div id="wrap-form">
		<h3>It looks like you have graded this image before. You can select from some of your saved data or start a new session.</h3>
		<form id="loadGradeForm">
			{% for g in gradeSessions %}
			<input type="radio" name="gradeSession" value={{g['gradeId']}} id="{{g['gradeId']}}">
			<label for="{{g['gradeId']}}">Time: {{g['timestamp']}} UTC  |  Cells Graded: {{g['cellsGraded']}}  |  Session: {{g['sessionId']}}</label><br/>
			{% endfor %}
			<input type="radio" name="gradeSession" value="-1" id="newOption">
			<label for="newOption">New grading session</label>
		</form>
		<button id="loadGradeBtn" onclick="loadGrades()">Select</button>
		</div>
	</div>
	{% endif %}

	<map name="map" id="gridMap">
	{% for i in coords %}
		<area id="cell_{{loop.index}}" shape="poly" coords="{{i}}" >
	{% endfor %}
	</map>

	<script>
		var xOffsetPercent = {{xOffset}}, yOffsetPercent = {{yOffset}};
		var url_view = "{{url_for('main.main_route')}}";
		var url_upload = "{{url_for('uploads.upload_route')}}";
		var url_his =  "{{url_for('his.his_route')}}";
		SCALE_GRID_RATIO = {{gridScaleRatio}};
		SCALE_GRID_RATIO_NORMAL = 1;
		var VERSION = '{{gitVersion}}';
		var GRADE_ID = -1;
	</script>


{% endblock %}


{% block js %}
<script src="{{url_for('static', filename='js/carousel.js')}}"></script>
<script src="{{url_for('static', filename='js/split.min.js')}}"></script>
<script src="{{url_for('static', filename='js/main.js')}}"></script>
<script src="{{url_for('static', filename='js/uploads.js')}}"></script>
<script>

$('document').ready()
{
	var gutterSize = 7;

	var leftRightScreenSplit = Split(['#leftScreen', '#rightScreen'], { 
		sizes : [45,55], 
		gutterSize: gutterSize,
		onDragEnd : function(){
			remap();
			if (hasCellBeenDrawn == true)
				drawCellManager(currentCell);
		} 
	});

	remap();
}
</script>

{% endblock %}
